#!/usr/bin/env bash

cd ${SAQ_HOME}
source bin/common.sh

MYSQL_DEFAULTS_FILE="/docker-entrypoint-initdb.d/mysql_defaults.root"

if [ ! -e $MYSQL_DEFAULTS_FILE ]
then
    echo "missing $MYSQL_DEFAULTS_FILE"
    exit 1
fi

if [ ! -d data/backups ]
then
    mkdir -p data/backups
fi

for db in ace
do
    backup_file="data/backups/$db-$(date '+%Y%m%d').sql"
    echo "creating backup of $db to $backup_file"
    mysqldump --defaults-file=$MYSQL_DEFAULTS_FILE --quick --single-transaction $db > $backup_file
    gzip -f $backup_file
done

# delete backups older than 7 days
if [ -d "data/backups" ]
then
    find -L "data/backups" -type f -name '*.sql.gz' -mtime +7 -delete
fi